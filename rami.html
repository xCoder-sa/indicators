<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø£Ø¯Ø§Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
  <style>
      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          direction: rtl;
          text-align: center;
          background-color: white;
          color: #333;
          margin: 0;
          padding: 0;
      }
      h1 {
          color: #2196F3; /* Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ */
          font-size: 2em;
          margin: 20px 0;
          text-shadow: 0px 0px 5px #2196F3;
      }
      .container {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 0 20px;
      }
      textarea {
          width: 80%;
          height: 150px;
          margin-bottom: 20px;
          border-radius: 10px;
          border: 2px solid #2196F3;
          padding: 10px;
          font-size: 1em;
          background-color: white;
          color: #333;
          resize: none;
          box-shadow: 0px 0px 10px #2196F3;
      }
      button {
          background-color: #2196F3; /* Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ */
          color: white;
          border: none;
          padding: 10px 20px;
          font-size: 1.2em;
          cursor: pointer;
          border-radius: 5px;
          margin-top: 10px;
          transition: 0.3s;
          box-shadow: 0px 0px 15px #2196F3;
      }
      button:hover {
          background-color: #1976D2; /* Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ø¯Ø§ÙƒÙ† Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ… */
          box-shadow: 0px 0px 20px #1976D2;
      }
      .table-container {
          width: 100%;
          margin: 20px 0;
      }
      table {
          width: 100%; /* Ø¶Ø¨Ø· Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„ÙŠÙƒÙˆÙ† 100% Ù…Ù† Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
          table-layout: fixed; /* ØªØ®Ø·ÙŠØ· Ø«Ø§Ø¨Øª Ù„Ù„Ø£Ø¹Ù…Ø¯Ø© */
          border-collapse: collapse;
          box-shadow: 0px 0px 20px #2196F3;
      }
      table, th, td {
          border: 1px solid #2196F3; /* Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ */
      }
      th, td {
          padding: 8px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø´Ùˆ */
          text-align: center;
          color: #2196F3;
          font-size: 0.9em; /* ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ø®Ø· */
          word-wrap: break-word; /* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ÙƒØ³Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø·ÙˆÙŠÙ„Ø© */
      }
      th {
          background-color: #2196F3;
          color: white;
      }
      .instruction {
          font-size: 1em;
          color: #2196F3;
          margin-bottom: 15px;
          text-shadow: 0px 0px 5px #2196F3;
      }
      .hidden {
          display: none;
      }
      footer {
          margin-top: 30px;
          font-size: 0.8em;
          color: red;
          text-shadow: 1px 1px 2px #000;
          text-align: center;
          padding: 10px 0;
          background-color: #f9f9f9;
      }
      footer a {
          color: #2196F3;
          text-decoration: none;
      }
      footer a:hover {
          text-decoration: underline;
      }
      .version {
          font-size: 0.9em;
          color: #555;
          margin-top: 10px;
      }
      .footer-highlight-ali, .footer-highlight-rami {
          font-weight: bold;
          color: #2196F3;
      }
      
      /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
      @media screen and (max-width: 1200px) {
          table {
              font-size: 0.8em;
          }
          th, td {
              padding: 6px;
          }
      }
      
      @media screen and (max-width: 992px) {
          textarea {
              width: 100%;
          }
          table {
              font-size: 0.7em;
          }
          th, td {
              padding: 5px;
          }
      }
      
      @media screen and (max-width: 768px) {
          table {
              font-size: 0.6em;
          }
          th, td {
              padding: 4px;
          }
      }
      
      @media screen and (max-width: 576px) {
          table {
              font-size: 0.5em;
          }
          th, td {
              padding: 3px;
          }
      }
  </style>
</head>
<body>

<h1>Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø£Ø¯Ø§Ø© Ù„Ù„Ø¥Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø´Ø®ØµÙŠ ÙÙ‚Ø· ğŸª</h1>

<div class="container">
  <p class="instruction">Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø·Ø¨ÙŠ Ø¨Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙƒÙ…Ø§ Ù‡ÙŠ</p>
  <textarea id="dataInput" placeholder="Ø£Ù„ØµÙ‚ Ù†Øµ Ø§Ù„ØµÙ Ù‡Ù†Ø§"></textarea>
  <button onclick="processData()">ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
  <button id="copyButton" class="hidden" onclick="copyTableData()">Ù†Ø³Ø®</button>
  <button id="downloadButton" class="hidden" onclick="downloadCSV()">ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§ÙƒØ³Ù„</button>
</div>

<div class="table-container">
  <table id="dataTable">
    <thead id="tableHead"></thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<footer>
    Design and Development by <span class="footer-highlight-ali">Ali Alshahrani</span><br>
    This script was created for <span class="footer-highlight-rami">Rami Albaqmi</span><br>
    Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ø³Ø®Ø©: 1.0
</footer>

<script>
// Ù†ÙØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (37 Ø¹Ù…ÙˆØ¯) Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„ÙØ§Ø±Øº ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
const columnsFile2 = [
  "Serial (Empty)",                       // 0  â† ÙØ§Ø±Øº Ø¯Ø§Ø¦Ù…Ø§Ù‹
  "Age",                                  // 1
  "Gender",                               // 2
  "Nationality",                          // 3
  "ID-Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©",                        // 4
  "Patient Name",                         // 5
  "Hospital Name",                        // 6  // Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©
  "ROSC",                                 // 7  // ÙØ§Ø±Øº
  "Ende of Resuscitation Effort",         // 8
  "AED/DEFIBRILLATOR",                    // 9  // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù‡Ø§Ø² Ù…Ø²ÙŠÙ„ Ø§Ù„Ø±Ø¬ÙØ§Ù†
  "OPA,NPA,BVM,ETT",                      // 10
  "IV /IO",                               // 11
  "ALS/BLS/ALS+BLS/ALS+ALS/BLS+BLS",      // 12
  "RR",                                   // 13
  "Prehospital Medications",              // 14
  "No.of shocks",                         // 15
  "Initial Rythm",                        // 16
  "Pre-arrival intrevention CPR initiated by", // 17
  "Time of arrest if(post arrival)",      // 18
  "Response time(min)from Incident time to Reach time", // 19
  "Response time(min)for the second team if applicable",// 20
  "Number of cycles",                     // 21 // Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙˆØ±Ø§Øª
  "Underlying cause of arrest",           // 22
  "Case code",                            // 23
  "Date",                                 // 24
  "Report No",                            // 25
  "Region",                               // 26
  "Witnessed By whom",                    // 27
  "EMT Code",                             // 28
  "EMT Code",                             // 29
  "Paramedic Code",                       // 30
  "Paramedic Code",                       // 31
  "Station Name",                         // 32
  "Mechanical CPR Device USE",            // 33
  "PROQA CODE",                           // 34
  "Estimated time of arrest",             // 35
  "NOTE"                                  // 36
];

/*
  mapping:
   - 24: Date â† Ø§Ù„Ø¹Ù…ÙˆØ¯ 0
   - 23: Case code â† Ø§Ù„Ø¹Ù…ÙˆØ¯ 2
   - 25: Report No â† Ø§Ù„Ø¹Ù…ÙˆØ¯ 3
   - 19: Response time â† Ø§Ù„Ø¹Ù…ÙˆØ¯ 4
   - 12: ALS/BLS â† Ø§Ù„Ø¹Ù…ÙˆØ¯ 6
   - 14: Prehospital Medications â† Ø§Ù„Ø¹Ù…ÙˆØ¯ 10
   - 16: Initial Rythm â† Ø§Ù„Ø¹Ù…ÙˆØ¯ 8
   - 15: No.of shocks â† Ø§Ù„Ø¹Ù…ÙˆØ¯ 19
   - 27: Witnessed By whom â† Ø§Ù„Ø¹Ù…ÙˆØ¯ 20
   - 8:  Ende of Resuscitation Effort â† Ø§Ù„Ø¹Ù…ÙˆØ¯ 14
   - 22: Underlying cause of arrest â† Ø§Ù„Ø¹Ù…ÙˆØ¯ 2
   - 34: PROQA CODE â† Ø§Ù„Ø¹Ù…ÙˆØ¯ 1
   - 36: NOTE â† Ø§Ù„Ø¹Ù…ÙˆØ¯ 15
   - 9:  AED/DEFIBRILLATOR â† Ø§Ù„Ø¹Ù…ÙˆØ¯ 9 (Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù‡Ø§Ø² Ù…Ø²ÙŠÙ„ Ø§Ù„Ø±Ø¬ÙØ§Ù†)
   - 21: Number of cycles â† Ø§Ù„Ø¹Ù…ÙˆØ¯ 19 (Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙˆØ±Ø§Øª)
   - **Ø£Ø¶ÙÙ†Ø§** 6: Hospital Name â† Ø§Ù„Ø¹Ù…ÙˆØ¯ 13 (Ù…Ø«Ø§Ù„) Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©
*/
const mapping = {
  24: 0,  
  23: 2,  
  25: 3,  
  19: 4,  
  12: 6,  
  14: 10, 
  16: 8,  
  15: 19, 
  27: 20, 
  8: 14,  
  22: 2,  
  34: 1,  
  36: 15, 
  9: 9,   
  21: 19, 
  // Ø¥Ø¹Ø§Ø¯Ø© "Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©" (Hospital Name) Ø¥Ù„Ù‰ Ø¹Ù…ÙˆØ¯ 6 Ø¨Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø«Ø§Ù†ÙŠ
  // ÙŠÙØªØ±Ø¶ Ø£Ù†Ù‡ ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ 13 Ø¨Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ÙˆÙ„ (Ù…Ø«Ø§Ù„)
  6: 13
};

// Ù†ÙØ³ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø±Ù…ÙˆØ² Ø§Ù„ØªØ±ÙˆÙ…Ø§
const traumaCodes = [29, 30, 27, 7, 17, 32];

function processData() {
  const input = document.getElementById("dataInput").value.trim();
  if (!input) {
    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
    return;
  }

  const tableBody = document.getElementById("tableBody");
  tableBody.innerHTML = "";

  // Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ÙØ§ØµÙ„
  const firstLine = input.split(/\r?\n/)[0];
  let delimiter = "\t";
  if (firstLine.includes(",")) delimiter = ",";
  else if (firstLine.includes(";")) delimiter = ";";

  const rows = input.split(/\r?\n/);
  const processedData = [];

  rows.forEach((line) => {
    if (!line.trim()) return; // Ø§Ù„Ø³Ø·Ø± ÙØ§Ø±Øº
    const cols = line.split(delimiter).map(x => x.trim());

    // Ø¨Ù†Ø§Ø¡ ØµÙ Ø¨Ø·ÙˆÙ„ 37
    let newRow = new Array(columnsFile2.length).fill("");

    // ØªØ·Ø¨ÙŠÙ‚ mapping
    for (const targetIndex in mapping) {
      const sourceIndex = mapping[targetIndex];
      if (cols[sourceIndex] !== undefined) {
        newRow[targetIndex] = cols[sourceIndex];
      }
    }

    // Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø®Ø§ØµØ© ÙƒÙ…Ø§ Ø³Ø¨Ù‚
    // 1) Ø­Ø°Ù Ø§Ù„ÙˆÙ‚Øª Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® (index 24)
    let originalDate = newRow[24] || "";
    if (originalDate.includes(" ")) {
      originalDate = originalDate.split(" ")[0];
    }
    newRow[24] = originalDate;

    // 2) Ø§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ø±Ù‚Ù… Ù…Ù† Case code (index 23)
    let originalCaseText = newRow[23] || "";
    let matchCase = originalCaseText.match(/^(\d+)/);
    if (matchCase) {
      newRow[23] = matchCase[1];
    }

    // 3) Underlying cause (index 22) => Trauma/Medical
    let causeText = newRow[22] || "";
    let causeMatch = causeText.match(/^(\d+)/);
    if (causeMatch) {
      let causeNum = parseInt(causeMatch[1], 10);
      if (traumaCodes.includes(causeNum)) {
        newRow[22] = "Trauma";
      } else {
        newRow[22] = "Medical";
      }
    } else {
      newRow[22] = "Medical";
    }

    // 4) ROSC (7) ÙØ§Ø±Øº
    newRow[7] = "";

    // Ø¨Ù†Ø§Ø¡ ØµÙ HTML
    const tr = document.createElement("tr");
    newRow.forEach(val => {
      const td = document.createElement("td");
      td.textContent = val;
      tr.appendChild(td);
    });
    tableBody.appendChild(tr);

    processedData.push(newRow);
  });

  window.processedData = processedData;

  const copyBtn = document.getElementById("copyButton");
  const downloadBtn = document.getElementById("downloadButton");
  if (processedData.length > 0) {
    copyBtn.classList.remove("hidden");
    downloadBtn.classList.remove("hidden");
  } else {
    copyBtn.classList.add("hidden");
    downloadBtn.classList.add("hidden");
  }
}

window.onload = () => {
  const tableHead = document.getElementById("tableHead");
  let tr = document.createElement("tr");
  columnsFile2.forEach(col => {
    const th = document.createElement("th");
    th.textContent = col;
    tr.appendChild(th);
  });
  tableHead.appendChild(tr);
};

function copyTableData() {
  const tableBody = document.getElementById("tableBody");
  const rows = tableBody.querySelectorAll("tr");
  let textToCopy = "";

  rows.forEach(row => {
    const cells = row.querySelectorAll("td");
    let rowText = "";
    cells.forEach((cell, index) => {
      rowText += cell.textContent;
      if (index < cells.length - 1) {
        rowText += "\t"; // ÙØ§ØµÙ„ Ø¹Ù„Ø§Ù…Ø© ØªØ¨ÙˆÙŠØ¨ Ø¨ÙŠÙ† Ø§Ù„Ø®Ù„Ø§ÙŠØ§
      }
    });
    textToCopy += rowText + "\n"; // ÙØ§ØµÙ„ Ø³Ø·Ø± Ø¨ÙŠÙ† Ø§Ù„ØµÙÙˆÙ
  });

  // Ø§Ø³ØªØ®Ø¯Ø§Ù… Clipboard API Ù„Ù†Ø³Ø® Ø§Ù„Ù†Øµ
  navigator.clipboard.writeText(textToCopy).then(() => {
    alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® ÙŠØ¨Ùˆ Ø³Ù†Ø¯");
  }).catch(err => {
    console.error('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®: ', err);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§.");
  });
}

function downloadCSV() {
  if (!window.processedData || window.processedData.length === 0) {
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªÙ†Ø²ÙŠÙ„.");
    return;
  }

  const allIndexes = [...Array(columnsFile2.length).keys()];
  let csvContent = ""; // Ø§Ø¨Ø¯Ø£ Ø¨Ø³Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©

  // Ø¥Ø¶Ø§ÙØ© BOM Ù„ØªÙ…ÙƒÙŠÙ† Excel Ù…Ù† Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØªØ±Ù…ÙŠØ² UTF-8
  csvContent += "\uFEFF";

  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‡ÙŠØ¯Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ØºØ¨ Ø¨Ø°Ù„Ùƒ. Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ØŒ Ø§Ù„Ù‡ÙŠØ¯Ø± ØºÙŠØ± Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ù†Ø³Ø®ØŒ ÙˆÙ„ÙƒÙ† ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„ØªÙ†Ø²ÙŠÙ„
  // Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ØºØ¨ ÙÙŠ ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ù‡ÙŠØ¯Ø± ÙÙŠ Ø§Ù„ØªÙ†Ø²ÙŠÙ„ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¶Ù…ÙŠÙ†Ù‡ Ù‡Ù†Ø§. Ø¥Ø°Ø§ Ù„Ù… ØªØ±ØºØ¨ØŒ Ø§ØªØ±ÙƒÙ‡ Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‡ÙŠØ¯Ø±
  // ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø«Ø§Ù„ØŒ Ø³Ø£Ø¨Ù‚ÙŠÙ‡ Ù…Ø¶Ø§ÙÙ‹Ø§ Ù„ØªÙƒÙˆÙ† Ù…Ù„Ù CSV Ù…ÙƒØªÙ…Ù„
  // Ù„ÙƒÙ† Ø¥Ø°Ø§ ÙƒÙ†Øª ØªÙØ¶Ù„ Ø¹Ø¯Ù… ØªØ¶Ù…ÙŠÙ†Ù‡ØŒ Ø¨Ø¨Ø³Ø§Ø·Ø© Ù‚Ù… Ø¨Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠ:
  csvContent += allIndexes.map(i => `"${columnsFile2[i]}"`).join(";") + "\n";

  window.processedData.forEach(row => {
    const csvRow = allIndexes
      .map(i => `"${(row[i] || "").replace(/"/g, '""')}"`)
      .join(";");
    csvContent += csvRow + "\n";
  });

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.setAttribute("href", url);
  link.setAttribute("download", "transformed_data.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>

</body>
</html>
